<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart MCQ System — Design by Irfan Ullah</title>

<!-- jsPDF CDN for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg:#1f2124;
    --panel:#2b2d30;
    --muted:#9aa0a6;
    --accent:#2b8cff;
    --gold:#d4af37;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#e6e7e8;background:linear-gradient(180deg,var(--bg),#151617);}
  .splash{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:60;
    background:radial-gradient(ellipse at center, rgba(43,140,255,0.06), rgba(0,0,0,0.6));
    backdrop-filter: blur(6px);
    transition:opacity .6s ease,transform .6s ease;
  }
  .splash.hidden{opacity:0;transform:translateY(-10px);pointer-events:none}
  .splash-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:34px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.6);text-align:center;min-width:320px;}
  .splash h1{margin:0;font-size:22px;letter-spacing:0.6px}
  .splash p{margin:8px 0 0;color:var(--muted)}
  .designer{margin-top:12px;font-size:12px;color:var(--gold);font-weight:600}
  .main{
    max-width:1024px;margin:48px auto;padding:24px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:12px;border:1px solid rgba(255,255,255,0.03);
    box-shadow:0 6px 30px rgba(0,0,0,0.6);display:grid;grid-template-columns:1fr 340px;gap:18px;
  }
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;}
  .logo{display:flex;align-items:center;gap:12px}
  .logo .dot{width:38px;height:38px;border-radius:8px;background:linear-gradient(180deg,var(--accent),#0066ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  h2{margin:0;color:white}
  .card{background:var(--panel);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .question-area{min-height:220px;display:flex;flex-direction:column;justify-content:space-between;padding:18px;position:relative;overflow:hidden}
  .question-text{font-size:18px;margin-bottom:12px;color:#f3f4f5}
  .options{display:flex;flex-direction:column;gap:10px}
  .option{background:var(--glass);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;transition:transform .18s ease,background .18s}
  .option:hover{transform:translateY(-3px)}
  .option.selected{outline:2px solid rgba(43,140,255,0.16);box-shadow:0 6px 18px rgba(43,140,255,0.06)}
  .controls{display:flex;align-items:center;justify-content:space-between;margin-top:14px;gap:10px}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#2b6bff);color:white;border:0}
  .progress-wrap{height:14px;border-radius:999px;background:rgba(255,255,255,0.03);overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  .progress{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#47a0ff);transition:width .6s linear}
  .progress.blue-animated{box-shadow:0 6px 30px rgba(43,140,255,0.12);animation:shimmer 2s linear infinite}
  @keyframes shimmer{0%{filter:brightness(1)}50%{filter:brightness(1.08)}100%{filter:brightness(1)}}
  .timer{font-weight:700;color:var(--gold)}
  .right-panel{display:flex;flex-direction:column;gap:12px}
  .meta{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .leaderboard-list{max-height:240px;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:6px}
  .leader{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02)}
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  .toggle{display:inline-flex;align-items:center;gap:8px}
  .admin-panel{display:flex;flex-direction:column;gap:8px}
  .input,textarea,select{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:#eaeaea}
  .fade-slide-enter{animation:fadeSlideIn .36s ease forwards}
  .fade-slide-exit{animation:fadeSlideOut .28s ease forwards}
  @keyframes fadeSlideIn{0%{opacity:0;transform:translateX(12px)}100%{opacity:1;transform:translateX(0)}}
  @keyframes fadeSlideOut{0%{opacity:1;transform:translateX(0)}100%{opacity:0;transform:translateX(-8px)}}
  footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}
  .badge{background:rgba(0,0,0,0.25);padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);font-weight:600}
  .center{display:flex;align-items:center;justify-content:center}
  .question-count{font-weight:700;color:#fff}
  .settings-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .file-input{display:none}
  .gold{color:var(--gold)}
  /* responsive */
  @media (max-width:980px){
    .main{grid-template-columns:1fr; padding:16px}
    .right-panel{order:2}
  }

/* welcome animation */
@keyframes fadeSlideInWelcome {
  0% { opacity: 0; transform: translateY(18px); }
  100% { opacity: 1; transform: translateY(0); }
}

</style>
</head>
<body>
<div style="margin-top:14px">
      <button class="btn primary" id="startBtn">Enter</button>
      <button class="btn" id="adminQuick">Admin</button>
    </div>
  </div>
</div>


<div class="login-screen" id="loginScreen">
  <div class="splash-card">
    <h1>Smart MCQ System</h1>
    <p class="muted">Secure Access • Admin + User Roles</p>
    <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
      <input id="loginUser" class="input" placeholder="Username" />
      <input id="loginPass" class="input" placeholder="Password" type="password" />
      <button class="btn primary" id="loginBtn">Login</button>
    </div>
    <div class="small muted" style="margin-top:10px;">Default Admin: admin/admin • User: user/user</div>
    <div class="designer" style="margin-top:10px;">Design by Irfan Ullah</div>
  </div>
</div>


<!-- Blocking Login Modal (appears before anything else) -->
<div id="blocker" style="position:fixed;inset:0;background:#0b0b0b;z-index:9999;display:flex;align-items:center;justify-content:center;">
  <div class="splash-card" style="max-width:420px;">
    <h1>Smart MCQ System</h1>
    <p class="muted">Secure Access • Admin + Users</p>

    <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px;">
      <input id="login_id" class="input" placeholder="User ID" autocomplete="off" />
      <input id="login_pw" class="input" placeholder="Password" type="password" autocomplete="off" />
      <div style="display:flex;gap:8px;margin-top:6px;">
        <button class="btn primary" id="login_submit">Login</button>
        <button class="btn" id="login_forgot">Forgot Password</button>
      </div>
    </div>

    <div class="small muted" style="margin-top:10px;">Default Admin ID: <span class="gold">Irfo321</span> / Password: <span class="gold">Irfo123</span></div>
    <div class="designer" style="margin-top:10px;">Design by Irfan Ullah</div>
  </div>
</div>

<!-- Welcome overlay for users (fade + slide) -->
<div id="welcomeOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:998;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);">
  <div id="welcomeCard" class="splash-card" style="max-width:520px;transform:translateY(12px);opacity:0;">
    <h2 id="welcomeText" style="margin:0">Welcome to exam, good luck</h2>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
      <button class="btn primary" id="startExamBtn">Start Exam</button>
    </div>
  </div>
</div>

<main class="main" id="app" style="opacity:1">
  <div>
    <header>
      <div class="logo">
        <div class="dot">IQ</div>
        <div>
          <h2>Smart MCQ System</h2>
          <div class="small muted">Admin + User • Dark theme • Exports</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="small muted">Overall time:</div>
        <div class="badge" id="overallTimerDisplay">--:--</div>
      </div>
    </header>

    <section class="card question-area fade-slide-enter" id="questionCard">
      <div>
        <div class="meta" style="margin-bottom:12px">
          <div class="question-count">Question <span id="qIndex">1</span>/<span id="qTotal">1</span></div>
          <div class="small muted">Category: <span id="qCat">General</span></div>
        </div>

        <div class="question-text" id="questionText">Loading...</div>

        <div class="options" id="options"></div>
      </div>

      <div style="margin-top:12px">
        <div class="progress-wrap" aria-hidden="true" title="Progress">
          <div class="progress blue-animated" id="progressBar" style="width:0%"></div>
        </div>

        <div class="controls" style="margin-top:10px">
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" id="prevBtn">Prev</button>
            <button class="btn primary" id="nextBtn">Next</button>
          </div>

          <div style="display:flex;align-items:center;gap:12px">
            <div class="small muted">Per-question:</div>
            <div class="timer" id="perTimerDisplay">--</div>
          </div>
        </div>
      </div>
    </section>

    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <button class="btn" id="submitBtn">Submit Exam</button>
      <button class="btn" id="restartBtn">Restart</button>
      <button class="btn" id="exportPdfBtn">Export Result (PDF)</button>
      <button class="btn" id="exportCsvBtn">Export CSV</button>
    </div>

    <footer>
      <div class="small muted">Built for demo — stores data locally in your browser. Contact: <span class="gold">Irfan Ullah</span></div>
    </footer>
  </div>

  <aside class="right-panel">
    <div class="card admin-panel" id="adminPanel">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:700">Admin Panel</div>
        <div class="small muted">Mode: <span id="modeLabel">User</span></div>
      </div>

      <div class="settings-row" style="margin-top:6px">
        <label class="toggle small muted"><input type="checkbox" id="togglePerQuestion"/> 60s per-question</label>
        <label class="toggle small muted"><input type="checkbox" id="toggleOverall"/> Enable overall timer</label>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <input class="input" id="overallMinutes" placeholder="Overall minutes (e.g. 30)" />
        <button class="btn" id="applyOverall">Apply</button>
      </div>

      <div style="margin-top:8px">
        <div class="small muted">Manage Questions</div>
        <textarea id="qEditor" placeholder='Paste JSON array of questions here' rows="6"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="loadQuestionsBtn">Load Questions</button>
          <button class="btn" id="downloadSample">Download Sample</button>
          <button class="btn" id="clearQuestions">Clear</button>
        </div>
      </div>

      <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.03);margin:8px 0">

      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;gap:8px">
          <input class="input" id="adminPass" placeholder="Admin password" type="password"/>
          <button class="btn" id="adminLogin">Login</button>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="exportQBtn">Export Qs</button>
          <button class="btn" id="importQBtn">Import Qs</button>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="clearStorage">Clear Storage</button>
          <button class="btn" id="viewResults">View Last Result</button>
        </div>
      </div>
    </div>

    <div class="card" style="padding:12px">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div><strong>Leaderboard</strong><div class="small muted">Top scores stored locally</div></div>
        <div><button class="btn" id="exportLb">Export LB</button></div>
      </div>
      <div class="leaderboard-list" id="leaderboard"></div>
    </div>

    <div class="card center" style="padding:12px">
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px">
        <div class="small muted">Quick Controls</div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="shuffleBtn">Shuffle Qs</button>
          <button class="btn" id="randomizeOptions">Shuffle Options</button>
        </div>
      </div>
    </div>

  </aside>
</main>

<script>
(() => {
  // Helpers
  const $ = sel => document.querySelector(sel);
  const qs = sel => Array.from(document.querySelectorAll(sel));
  const sampleQuestions = [
    {"id":1,"q":"What is the capital of France?","options":["Berlin","Paris","Madrid","Rome"],"answer":1,"category":"General"},
    {"id":2,"q":"Which language runs in a web browser?","options":["Python","Java","C++","JavaScript"],"answer":3,"category":"Tech"},
    {"id":3,"q":"2 + 2 * 2 = ?","options":["8","6","4","2"],"answer":1,"category":"Math"}
  ];

  // State
  let questions = JSON.parse(localStorage.getItem('smart_questions') || 'null') || sampleQuestions.slice();
  let answers = JSON.parse(localStorage.getItem('smart_answers') || 'null') || {};
  let current = 0;
  let perQuestionEnabled = JSON.parse(localStorage.getItem('smart_perq') || 'false');
  let perQuestionSeconds = 60;
  let perTimer = null;
  let overallEnabled = JSON.parse(localStorage.getItem('smart_overall') || 'false');
  let overallMinutes = parseInt(localStorage.getItem('smart_overall_minutes')||'0') || 0;
  let overallTimer = null;
  let overallRemaining = 0;
  let examStart = null;

  // UI
  const qIndex = $('#qIndex');
  const qTotal = $('#qTotal');
  const qText = $('#questionText');
  const optionsWrap = $('#options');
  const progressBar = $('#progressBar');
  const perTimerDisplay = $('#perTimerDisplay');
  const overallTimerDisplay = $('#overallTimerDisplay');
  const modeLabel = $('#modeLabel');
  const leaderboardEl = $('#leaderboard');

  function saveState(){
    localStorage.setItem('smart_questions', JSON.stringify(questions));
    localStorage.setItem('smart_answers', JSON.stringify(answers));
    localStorage.setItem('smart_perq', JSON.stringify(perQuestionEnabled));
    localStorage.setItem('smart_overall', JSON.stringify(overallEnabled));
    localStorage.setItem('smart_overall_minutes', String(overallMinutes));
  }

  function renderQuestion(i, animate=true){
    if(i<0) i=0;
    if(i>=questions.length) i=questions.length-1;
    current = i;
    qIndex.textContent = current+1;
    qTotal.textContent = questions.length;
    const Q = questions[current];
    $('#qCat').textContent = Q.category || 'General';
    qText.textContent = Q.q;
    optionsWrap.innerHTML = '';
    Q.options.forEach((opt, idx) => {
      const b = document.createElement('div');
      b.className = 'option';
      b.tabIndex = 0;
      b.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div>${String.fromCharCode(65+idx)}. ${opt}</div></div>`;
      if(answers[Q.id] === idx) b.classList.add('selected');
      b.onclick = () => {
        answers[Q.id] = idx;
        saveState();
        qs('.option').forEach(x=>x.classList.remove('selected'));
        b.classList.add('selected');
      };
      optionsWrap.appendChild(b);
    });
    // progress
    const pct = Math.round(((current+1)/questions.length)*100);
    progressBar.style.width = pct + '%';

    // per-question timer
    resetPerTimer();
    if(perQuestionEnabled){
      startPerTimer();
    } else {
      perTimerDisplay.textContent = '--';
    }
  }

  // Per-question timer
  function startPerTimer(){
    clearInterval(perTimer);
    let t = perQuestionSeconds;
    perTimerDisplay.textContent = t + 's';
    perTimer = setInterval(()=>{
      t--;
      perTimerDisplay.textContent = t + 's';
      if(t<=0){
        clearInterval(perTimer);
        // auto-next
        goNext();
      }
    },1000);
  }
  function resetPerTimer(){
    clearInterval(perTimer);
    perTimer = null;
  }

  // Overall timer
  function startOverallTimer(){
    clearInterval(overallTimer);
    if(!overallEnabled || overallMinutes<=0) return;
    if(!examStart) examStart = Date.now();
    overallRemaining = overallMinutes*60;
    overallTimerDisplay.textContent = formatTime(overallRemaining);
    overallTimer = setInterval(()=>{
      overallRemaining--;
      overallTimerDisplay.textContent = formatTime(overallRemaining);
      if(overallRemaining<=0){
        clearInterval(overallTimer);
        submitExam();
      }
    },1000);
  }
  function stopOverallTimer(){ clearInterval(overallTimer); overallTimer=null; overallTimerDisplay.textContent='--:--'; }

  function formatTime(sec){
    if(sec<=0) return '00:00';
    const m = Math.floor(sec/60); const s = sec%60;
    return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
  }

  // Navigation
  function goNext(){
    if(current < questions.length-1){
      renderQuestion(current+1);
    } else {
      // end
      submitExam();
    }
  }
  function goPrev(){ if(current>0) renderQuestion(current-1); }

  // Submit
  function grade(){
    let score=0;
    questions.forEach(q=>{
      const sel = answers[q.id];
      if(sel === q.answer) score++;
    });
    return {score, total:questions.length, pct: Math.round((score/questions.length)*100)};
  }

  function submitExam(){
    stopOverallTimer();
    resetPerTimer();
    const res = grade();
    const name = prompt('Enter your name for leaderboard','Guest') || 'Guest';
    const entry = {name,score:res.score,total:res.total,pct:res.pct,date:new Date().toISOString()};
    const lb = JSON.parse(localStorage.getItem('smart_lb')||'[]');
    lb.push(entry);
    lb.sort((a,b)=>b.pct - a.pct || b.score - a.score);
    localStorage.setItem('smart_lb', JSON.stringify(lb.slice(0,50)));
    localStorage.setItem('smart_last_result', JSON.stringify({res,answers,questions,name,when:new Date().toISOString()}));
    renderLeaderboard();
    alert(`Submitted. Score: ${res.score}/${res.total} (${res.pct}%)`);
  }

  function renderLeaderboard(){
    const lb = JSON.parse(localStorage.getItem('smart_lb')||'[]');
    leaderboardEl.innerHTML = '';
    lb.slice(0,10).forEach((e,idx)=>{
      const d = document.createElement('div');
      d.className='leader';
      d.innerHTML = `<div><strong>${idx+1}. ${e.name}</strong><div class="small muted">${e.date.slice(0,10)}</div></div><div style="text-align:right"><div class="gold">${e.pct}%</div><div class="small muted">${e.score}/${e.total}</div></div>`;
      leaderboardEl.appendChild(d);
    });
  }

  // Admin features
  $('#loadQuestionsBtn').onclick = () => {
    try{
      const j = JSON.parse($('#qEditor').value);
      if(!Array.isArray(j)) throw 'Not an array';
      questions = j.map((qq, i)=>({...qq, id: qq.id|| (i+1)}));
      answers = {};
      saveState();
      renderQuestion(0);
      alert('Questions loaded: '+questions.length);
    }catch(e){ alert('Invalid JSON: ' + e); }
  };
  $('#downloadSample').onclick = () => {
    const blob = new Blob([JSON.stringify(sampleQuestions,null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sample_questions.json'; a.click();
  };
  $('#clearQuestions').onclick = ()=>{
    if(!confirm('Clear questions?')) return;
    questions = [];
    answers = {};
    saveState();
    renderQuestion(0);
  };
  $('#exportQBtn').onclick = ()=>{
    const blob = new Blob([JSON.stringify(questions,null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='export_questions.json'; a.click();
  };
  $('#importQBtn').onclick = ()=>{
    const f = document.createElement('input'); f.type='file'; f.accept='.json'; f.onchange = e=>{
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = ev=>{
        try{
          const j=JSON.parse(ev.target.result);
          questions = j.map((qq,i)=>({...qq, id: qq.id|| (i+1)}));
          answers={};
          saveState(); renderQuestion(0); alert('Imported '+questions.length);
        }catch(err){alert('Invalid file');}
      };
      reader.readAsText(file);
    }; f.click();
  };

  $('#adminLogin').onclick = ()=>{
    const pass = $('#adminPass').value;
    if(pass==='admin'){
      modeLabel.textContent='Admin';
      $('#adminPanel').style.border='1px solid rgba(212,175,55,0.4)';
      alert('Admin mode active');
    } else {
      alert('Wrong password');
    }
  };

  $('#clearStorage').onclick = ()=>{
    if(confirm('Clear all stored data (questions, answers, leaderboard)?')){
      localStorage.clear(); location.reload();
    }
  };

  $('#viewResults').onclick = ()=>{
    const lr = JSON.parse(localStorage.getItem('smart_last_result')||'null');
    if(!lr){ alert('No last result'); return;}
    const popup = window.open('','_blank','width=600,height=600');
    popup.document.write('<pre style="white-space:pre-wrap;font-family:monospace">'+JSON.stringify(lr,null,2)+'</pre>');
  };

  $('#applyOverall').onclick = ()=>{
    const val = parseInt($('#overallMinutes').value||'0');
    if(!isNaN(val) && val>0){
      overallMinutes = val;
      overallEnabled = true;
      localStorage.setItem('smart_overall_minutes', String(overallMinutes));
      localStorage.setItem('smart_overall', JSON.stringify(overallEnabled));
      alert('Applied overall time: ' + overallMinutes + ' minutes');
      startOverallTimer();
    } else {
      alert('Enter valid minutes');
    }
  };

  // shuffle helpers
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
  $('#shuffleBtn').onclick = ()=>{ questions = shuffle(questions); renderQuestion(0); saveState(); };
  $('#randomizeOptions').onclick = ()=>{ questions.forEach(q=>{ q.options = shuffle(q.options); }); renderQuestion(0); saveState(); };

  // Exports
  $('#exportPdfBtn').onclick = async ()=>{
    const lr = JSON.parse(localStorage.getItem('smart_last_result')||'null');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    if(!lr){ alert('No last result to export'); return;}
    doc.setFontSize(14); doc.text('Smart MCQ Result',14,18);
    doc.setFontSize(11); doc.text(`Name: ${lr.name} | Score: ${lr.res.score}/${lr.res.total} (${lr.res.pct}%)`,14,28);
    let y=40;
    lr.questions.forEach((q,idx)=>{
      doc.setFontSize(10);
      let txt = `${idx+1}. ${q.q}  (Answer: ${String.fromCharCode(65 + q.answer)})`;
      doc.text(txt,14,y);
      y+=6;
      if(y>270){ doc.addPage(); y=20; }
    });
    doc.save('result.pdf');
  };

  $('#exportCsvBtn').onclick = ()=>{
    const lr = JSON.parse(localStorage.getItem('smart_last_result')||'null');
    if(!lr){ alert('No last result'); return;}
    const rows = [['Question','CorrectOption','SelectedOption','Correct?']];
    lr.questions.forEach(q=>{
      const sel = lr.answers[q.id];
      rows.push([q.q, q.options[q.answer], sel!=null ? q.options[sel] : '', String(sel===q.answer)]);
    });
    const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='results.csv'; a.click();
  };

  $('#exportLb').onclick = ()=>{
    const lb = JSON.parse(localStorage.getItem('smart_lb')||'[]');
    const csv = ['Name,Score,Total,Percent,Date', ...lb.map(l=>`${l.name},${l.score},${l.total},${l.pct},${l.date}`)].join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='leaderboard.csv'; a.click();
  };

  $('#startBtn').onclick = ()=>{
    document.getElementById('splash').classList.add('hidden');
    startOverallTimer();
  };
  $('#adminQuick').onclick = ()=>{
    document.getElementById('splash').classList.add('hidden');
    $('#adminPass').value='admin';
    $('#adminLogin').click();
  };

  // Basic controls
  $('#prevBtn').onclick = goPrev;
  $('#nextBtn').onclick = goNext;
  $('#submitBtn').onclick = ()=>{ if(confirm('Submit exam?')) submitExam(); };
  $('#restartBtn').onclick = ()=>{ if(confirm('Restart exam?')){ answers={}; localStorage.setItem('smart_answers', JSON.stringify(answers)); renderQuestion(0); } };

  // toggles
  $('#togglePerQuestion').checked = perQuestionEnabled;
  $('#togglePerQuestion').onchange = (e)=>{ perQuestionEnabled = e.target.checked; localStorage.setItem('smart_perq', JSON.stringify(perQuestionEnabled)); if(perQuestionEnabled) startPerTimer(); else resetPerTimer(); };
  $('#toggleOverall').checked = overallEnabled;
  $('#toggleOverall').onchange = (e)=>{ overallEnabled = e.target.checked; localStorage.setItem('smart_overall', JSON.stringify(overallEnabled)); if(overallEnabled) startOverallTimer(); else stopOverallTimer(); };

  
  // Role-based login
  const loginScreen = document.getElementById('loginScreen');
  const loginBtn = document.getElementById('loginBtn');
  const loginUser = document.getElementById('loginUser');
  const loginPass = document.getElementById('loginPass');
  let userRole = null;

  const storedCreds = JSON.parse(localStorage.getItem('smart_creds') || '{"admin":"YWRtaW4=","user":"dXNlcg=="}'); // base64 encoded

  function checkLogin(u, p){
    const enc = btoa(p);
    if(u==='admin' && storedCreds.admin===enc) return 'admin';
    if(u==='user' && storedCreds.user===enc) return 'user';
    return null;
  }

  loginBtn.onclick = ()=>{
    const role = checkLogin(loginUser.value.trim(), loginPass.value.trim());
    if(!role){ alert('Invalid credentials'); return; }
    userRole = role;
    loginScreen.style.display='none';
    document.getElementById('app').style.opacity='1';
    if(userRole==='user'){
      // hide admin controls
      document.getElementById('adminPanel').style.display='none';
    }
    if(overallEnabled) startOverallTimer();
  };

  // allow admin to change passwords
  const passChangeUI = document.createElement('div');
  passChangeUI.innerHTML = `
  <div style="margin-top:8px">
    <div class="small muted">Change Passwords</div>
    <input class="input" id="newAdminPass" placeholder="New Admin Password" type="password"/>
    <input class="input" id="newUserPass" placeholder="New User Password" type="password" style="margin-top:4px"/>
    <button class="btn" id="savePass">Save Passwords</button>
  </div>`;
  document.getElementById('adminPanel').appendChild(passChangeUI);

  passChangeUI.querySelector('#savePass').onclick = ()=>{
    const npA = passChangeUI.querySelector('#newAdminPass').value.trim();
    const npU = passChangeUI.querySelector('#newUserPass').value.trim();
    if(npA) storedCreds.admin = btoa(npA);
    if(npU) storedCreds.user = btoa(npU);
    localStorage.setItem('smart_creds', JSON.stringify(storedCreds));
    alert('Passwords updated.');
  };

  // init
  function init(){
    if(!questions || questions.length===0) { questions = sampleQuestions.slice(); localStorage.setItem('smart_questions', JSON.stringify(questions)); }
    qTotal.textContent = questions.length;
    renderQuestion(0);
    renderLeaderboard();
    // show designer credit in title
    document.title += ' — Design by Irfan Ullah';
  }
  
  // --- ACCESS CONTROL / USER MANAGEMENT START ---
  (function(){
    const adminDefault = {id: 'Irfo321', pw: btoa('Irfo123')};
    let adminObj = JSON.parse(localStorage.getItem('smart_admin') || 'null') || adminDefault;
    localStorage.setItem('smart_admin', JSON.stringify(adminObj));
    let users = JSON.parse(localStorage.getItem('smart_users') || '{}');

    const blocker = document.getElementById('blocker');
    const login_submit = document.getElementById('login_submit');
    const login_id = document.getElementById('login_id');
    const login_pw = document.getElementById('login_pw');
    const login_forgot = document.getElementById('login_forgot');
    const welcomeOverlay = document.getElementById('welcomeOverlay');
    const welcomeCard = document.getElementById('welcomeCard');
    const startExamBtn = document.getElementById('startExamBtn');

    let LOGGED_IN = null;

    function hideAllUIBeforeLogin(){
      document.getElementById('app').style.opacity = '0';
      document.getElementById('app').style.pointerEvents = 'none';
    }
    hideAllUIBeforeLogin();

    function showAppAfterLogin(){
      document.getElementById('app').style.opacity = '1';
      document.getElementById('app').style.pointerEvents = 'auto';
      let topRight = document.querySelector('header > div[style*="display:flex"]');
      if(topRight){
        let existing = document.getElementById('loggedInBadge');
        if(!existing){
          const sp = document.createElement('div');
          sp.id = 'loggedInBadge';
          sp.className = 'badge';
          sp.style.marginLeft = '12px';
          sp.textContent = 'Logged in: ' + LOGGED_IN.id;
          topRight.appendChild(sp);
        } else {
          existing.textContent = 'Logged in: ' + LOGGED_IN.id;
        }
      }
    }

    function saveUsers(){
      localStorage.setItem('smart_users', JSON.stringify(users));
    }

    function openManageUsersModal(){
      const modal = document.createElement('div');
      modal.id = 'manageUsersModal';
      modal.style.position='fixed';
      modal.style.inset='0';
      modal.style.zIndex='10000';
      modal.style.display='flex';
      modal.style.alignItems='center';
      modal.style.justifyContent='center';
      modal.style.background='rgba(0,0,0,0.6)';
      modal.innerHTML = `
        <div class="splash-card" style="width:720px;max-width:95%;">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Manage Users</h3>
            <button class="btn" id="closeManageUsers">Close</button>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <input class="input" id="searchUser" placeholder="Search by ID" />
            <button class="btn" id="addUserBtn">Add User</button>
            <button class="btn" id="exportUsersBtn">Export</button>
            <button class="btn" id="importUsersBtn">Import</button>
          </div>
          <div id="usersList" style="margin-top:10px;max-height:300px;overflow:auto"></div>
        </div>
      `;
      document.body.appendChild(modal);

      function renderList(filter){
        const list = modal.querySelector('#usersList');
        list.innerHTML = '';
        const entries = Object.entries(users);
        entries.sort((a,b)=> (a[0].toLowerCase()>b[0].toLowerCase())?1:-1);
        entries.filter(([id,info])=>!filter || id.toLowerCase().includes(filter.toLowerCase())).forEach(([id,info])=>{
          const row = document.createElement('div');
          row.style.display='flex';
          row.style.justifyContent='space-between';
          row.style.alignItems='center';
          row.style.padding='8px';
          row.style.borderBottom='1px solid rgba(255,255,255,0.03)';
          row.innerHTML = `<div><strong>${id}</strong><div class="small muted">Last Login: ${info.lastLogin?info.lastLogin.slice(0,19):'Never'}</div></div>
            <div style="display:flex;gap:6px">
              <button class="btn" data-edit="${id}">Edit</button>
              <button class="btn" data-del="${id}">Delete</button>
            </div>`;
          list.appendChild(row);
        });
      }
      renderList();

      modal.querySelector('#searchUser').addEventListener('input',(e)=>renderList(e.target.value));
      modal.querySelector('#closeManageUsers').addEventListener('click',()=>modal.remove());
      modal.querySelector('#addUserBtn').addEventListener('click',()=>{
        const uid = prompt('New User ID (no spaces)');
        if(!uid) return;
        if(users[uid]){ alert('User exists'); return; }
        const pw = prompt('Password for '+uid);
        users[uid] = {pw: btoa(pw||''), lastLogin: null};
        saveUsers();
        renderList();
      });
      modal.querySelector('#exportUsersBtn').addEventListener('click',()=>{
        const blob = new Blob([JSON.stringify(users,null,2)],{type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='users.json'; a.click();
      });
      modal.querySelector('#importUsersBtn').addEventListener('click',()=>{
        const f = document.createElement('input'); f.type='file'; f.accept='.json';
        f.onchange = e=>{
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = ev=>{
            try{
              const j = JSON.parse(ev.target.result);
              users = j;
              saveUsers();
              renderList();
              alert('Imported users');
            }catch(err){ alert('Invalid file'); }
          };
          reader.readAsText(file);
        };
        f.click();
      });

      modal.addEventListener('click',(ev)=>{
        const edit = ev.target.closest('button[data-edit]');
        const del = ev.target.closest('button[data-del]');
        if(edit){
          const id = edit.getAttribute('data-edit');
          const newPw = prompt('New password for ' + id);
          if(newPw!=null){ users[id].pw = btoa(newPw); saveUsers(); renderList(); alert('Updated'); }
        }
        if(del){
          const id = del.getAttribute('data-del');
          if(confirm('Delete user '+id+'?')){ delete users[id]; saveUsers(); renderList(); }
        }
      });
    }

    function attachManageUsersButton(){
      const adminPanel = document.getElementById('adminPanel');
      if(!adminPanel) return;
      if(!document.getElementById('manageUsersBtn')){
        const btn = document.createElement('button');
        btn.className='btn';
        btn.id='manageUsersBtn';
        btn.textContent='Manage Users';
        btn.style.marginTop='8px';
        adminPanel.appendChild(btn);
        btn.addEventListener('click',()=>openManageUsersModal());
      }
    }
    attachManageUsersButton();

    login_submit.addEventListener('click',(e)=>{
      const id = login_id.value.trim();
      const pw = login_pw.value || '';
      if(!id){ alert('Enter ID'); return; }
      const enc = btoa(pw);
      adminObj = JSON.parse(localStorage.getItem('smart_admin') || 'null') || adminDefault;
      if(id === adminObj.id && enc === adminObj.pw){
        LOGGED_IN = {id: id, role: 'admin'};
        blocker.style.display='none';
        showAppAfterLogin();
        const adminPanel = document.getElementById('adminPanel');
        if(adminPanel) adminPanel.style.display='';
        adminObj.lastLogin = new Date().toISOString();
        localStorage.setItem('smart_admin', JSON.stringify(adminObj));
        return;
      }
      users = JSON.parse(localStorage.getItem('smart_users') || '{}');
      if(users[id] && users[id].pw === enc){
        LOGGED_IN = {id:id, role:'user'};
        users[id].lastLogin = new Date().toISOString();
        saveUsers();
        blocker.style.display='none';
        showAppAfterLogin();
        welcomeOverlay.style.display='flex';
        setTimeout(()=>{ welcomeCard.style.transition='all 400ms ease'; welcomeCard.style.transform='translateY(0)'; welcomeCard.style.opacity='1'; }, 40);
        const adminPanel = document.getElementById('adminPanel');
        if(adminPanel) adminPanel.style.display='none';
        const nodesToHide = ['exportQBtn','importQBtn','clearQuestions','viewResults','exportLb','applyOverall','downloadSample','adminLogin'];
        nodesToHide.forEach(idn=>{ const el=document.getElementById(idn); if(el) el.style.display='none'; });
        return;
      }
      alert('Invalid credentials');
    });

    login_forgot.addEventListener('click',()=>{
      if(confirm('Reset Admin credentials to defaults? (Irfo321 / Irfo123)')){
        const adminDefaultObj = {id:'Irfo321', pw: btoa('Irfo123'), lastLogin: null};
        localStorage.setItem('smart_admin', JSON.stringify(adminDefaultObj));
        alert('Admin credentials reset to defaults.');
      }
    });

    startExamBtn.addEventListener('click', ()=>{
      welcomeOverlay.style.display='none';
    });

    window.SmartUserManager = {
      getUsers: ()=>JSON.parse(localStorage.getItem('smart_users')||'{}'),
      getAdmin: ()=>JSON.parse(localStorage.getItem('smart_admin')||'null'),
      setAdmin: (id,pw)=>{ localStorage.setItem('smart_admin', JSON.stringify({id:id,pw:btoa(pw)})); },
      addUser: (id,pw)=>{ users = JSON.parse(localStorage.getItem('smart_users')||'{}'); users[id]={pw:btoa(pw), lastLogin:null}; localStorage.setItem('smart_users', JSON.stringify(users)); }
    };

    attachManageUsersButton();

  })();

    
  (function(){
    const adminPanel = document.getElementById('adminPanel');
    if(!adminPanel) return;
    if(!document.getElementById('quickCreateUser')){
      const wrap = document.createElement('div');
      wrap.id = 'quickCreateUser';
      wrap.style.marginTop='8px';
      wrap.innerHTML = `<div class="small muted">Quick Create User</div>
        <input class="input" id="newUserId" placeholder="User ID" />
        <input class="input" id="newUserPw" placeholder="Password" type="password" />
        <div style="display:flex;gap:8px;margin-top:6px"><button class="btn" id="createUserBtn">Create</button><button class="btn" id="listUsersBtn">List Users</button></div>`;
      adminPanel.appendChild(wrap);
      document.getElementById('createUserBtn').addEventListener('click',()=>{
        const id = document.getElementById('newUserId').value.trim();
        const pw = document.getElementById('newUserPw').value;
        if(!id){ alert('Enter ID'); return; }
        let users = JSON.parse(localStorage.getItem('smart_users')||'{}');
        if(users[id]){ alert('User exists'); return; }
        users[id] = {pw: btoa(pw||''), lastLogin: null};
        localStorage.setItem('smart_users', JSON.stringify(users));
        alert('User created: ' + id);
        document.getElementById('newUserId').value=''; document.getElementById('newUserPw').value='';
      });
      document.getElementById('listUsersBtn').addEventListener('click',()=>{
        const users = JSON.parse(localStorage.getItem('smart_users')||'{}');
        const out = Object.keys(users).map(k=>k + ' — Last: ' + (users[k].lastLogin?users[k].lastLogin.slice(0,19):'Never')).join('\n');
        alert(out || 'No users');
      });
    }
  })();

    init();

  // keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowRight') goNext();
    if(e.key==='ArrowLeft') goPrev();
    if(e.key==='Enter') goNext();
  });

})();
</script>
</body>
</html>
